<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>Leaflet.markercluster – 100人（20m 聚集 >10 顯示紅色，其餘黃色）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }

    /* 單一人員 marker（DivIcon 小圓點） -> 黃色 */
    .pin {
      width: 12px; height: 12px; border-radius: 50%;
      border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,.25);
      background: #f59e0b; /* 黃色 */
    }

    /* 小資訊面板 */
    .info {
      position: absolute; z-index: 1000; top: 12px; left: 12px;
      background: rgba(255,255,255,0.94); border-radius: 10px; padding: 8px 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "PingFang TC", "Microsoft JhengHei", sans-serif;
      font-size: 13px; color: #222;
    }
    .info b { color: #111; }

    /* 自訂 cluster 顏色：
       - 其餘（<=10）→ 黃色
       - >20m不影響顏色，顏色只看人數，半徑由 maxClusterRadius 控制
       - >10 → 紅色
    */
    .marker-cluster-yellow {
      background-color: rgba(245, 158, 11, 0.6);
      border: 3px solid #f59e0b;
      color: #1f2937;
    }
    .marker-cluster-yellow div {
      background: #f59e0b;
      color: #1f2937;
    }

    .marker-cluster-red {
      background-color: rgba(239, 68, 68, 0.6);
      border: 3px solid #ef4444;
      color: #fff;
    }
    .marker-cluster-red div {
      background: #ef4444;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="info">
    隨機人員：<b>100</b> 人（中心約 800m 內）<br/>
    聚合半徑：<b>20 公尺</b>（動態換算像素）<br/>
    群集 <b>&gt; 10</b> 人 → <span style="color:#ef4444;font-weight:bold;">紅色</span>；其餘 <span style="color:#f59e0b;font-weight:bold;">黃色</span>
  </div>

  <script>
    // ====== 參數設定 ======
    const MAP_CENTER = [22.96834, 120.16625]; // 固定中心
    const PEOPLE_COUNT = 100;                  // 隨機 100 人
    const SCATTER_RADIUS_M = 200;              // 亂數散佈半徑（相對中心）
    const CLUSTER_RADIUS_M = 20;               // 用 20m 當作聚合半徑（轉像素）

    // ====== 地圖初始化 ======
    const map = L.map('map').setView(MAP_CENTER, 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // ====== 公尺 <-> 像素換算（Web Mercator 近似） ======
    function metersPerPixelAtLat(lat, zoom) {
      return 156543.03392 * Math.cos(lat * Math.PI / 180) / Math.pow(2, zoom);
    }
    function metersToPixels(meters, lat, zoom) {
      return meters / metersPerPixelAtLat(lat, zoom);
    }

    // ====== 以中心為圓心，R 公尺內亂數取點 ======
    function randomPointWithinMeters(centerLatLng, radiusMeters) {
      const d = Math.random() * radiusMeters;     // 0..R（m）
      const theta = Math.random() * 2 * Math.PI;  // 0..2π
      const dLat = (d * Math.cos(theta)) / 111320;
      const dLng = (d * Math.sin(theta)) / (111320 * Math.cos(centerLatLng.lat * Math.PI / 180));
      return L.latLng(centerLatLng.lat + dLat, centerLatLng.lng + dLng);
    }

    // ====== 建立 100 個人員點 ======
    function makeDotIcon() {
      return L.divIcon({ className: '', html: `<div class="pin"></div>`, iconSize: [12,12], iconAnchor: [6,6] });
    }
    const personIcon = makeDotIcon();
    const peopleMarkers = [];
    const centerLL = L.latLng(MAP_CENTER[0], MAP_CENTER[1]);

    for (let i = 0; i < PEOPLE_COUNT; i++) {
      const p = randomPointWithinMeters(centerLL, SCATTER_RADIUS_M);
      peopleMarkers.push(L.marker(p, { icon: personIcon }).bindPopup(`人員 #${i+1}`));
    }

    // ====== Cluster：maxClusterRadius = 20m (轉像素)；>10 人顯示紅色，其餘黃色 ======
    const clusterGroup = L.markerClusterGroup({
      maxClusterRadius: function(zoom) {
        const px = metersToPixels(CLUSTER_RADIUS_M, map.getCenter().lat, zoom);
        return Math.max(1, Math.round(px));
      },
      spiderfyOnMaxZoom: true,
      showCoverageOnHover: false,

      iconCreateFunction: function (cluster) {
        const count = cluster.getChildCount();

        // 以人數決定顏色：>10 紅，其他黃
        const colorClass = (count > 10) ? ' marker-cluster-red' : ' marker-cluster-yellow';

        // 用 size 類別保留原外觀尺寸（small/medium/large 只是大小，不代表顏色）
        let sizeClass = ' marker-cluster-small';
        if (count > 10 && count <= 50) sizeClass = ' marker-cluster-medium';
        if (count > 50) sizeClass = ' marker-cluster-large';

        return new L.DivIcon({
          html: `<div><span>${count}</span></div>`,
          className: 'marker-cluster' + sizeClass + colorClass,
          iconSize: new L.Point(40, 40)
        });
      }
    });

    peopleMarkers.forEach(m => clusterGroup.addLayer(m));
    map.addLayer(clusterGroup);
  </script>
</body>
</html>
